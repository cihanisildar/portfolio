import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const postsDir = path.join(__dirname, "..", "content", "posts");
const outputPath = path.join(__dirname, "..", "content", "post-map.tsx");

const files = fs.readdirSync(postsDir).filter((f) => f.endsWith(".mdx"));
const slugs = files.map((f) => f.replace(/\.mdx$/, ""));

const imports = slugs
  .map((slug) => {
    const id = slug.replace(/[^a-zA-Z0-9_]/g, "_");
    return `import ${id} from "./posts/${slug}.mdx";`;
  })
  .join("\n");

const entries = slugs
  .map((slug) => {
    const id = slug.replace(/[^a-zA-Z0-9_]/g, "_");
    return `  "${slug}": ${id},`;
  })
  .join("\n");

const content = `// Auto-generated by scripts/generate-post-map.mjs â€“ do not edit
${imports}

import type { ComponentType } from "react";

export const postMap: Record<string, ComponentType> = {
${entries}
};

export const postSlugs = ${JSON.stringify(slugs)} as const;
`;

fs.writeFileSync(outputPath, content, "utf8");
console.log("Generated", outputPath, "with", slugs.length, "posts");
